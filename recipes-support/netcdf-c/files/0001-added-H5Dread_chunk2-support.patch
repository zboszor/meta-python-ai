From 1f1f359aeb4a31c47410d36581a141bb04d7b4a1 Mon Sep 17 00:00:00 2001
From: Scot Breitenfeld <brtnfld@hdfgroup.org>
Date: Fri, 13 Jun 2025 16:44:18 -0500
Subject: [PATCH 1/2] added H5Dread_chunk2 support

Upstream-Status: Backport
---
 cmake/dependencies.cmake   |  3 +++
 configure.ac               |  5 ++++-
 nc_test4/tst_alignment.c   |  5 +++++
 nczarr_test/ncdumpchunks.c | 10 ++++++++--
 4 files changed, 20 insertions(+), 3 deletions(-)

diff --git a/cmake/dependencies.cmake b/cmake/dependencies.cmake
index d06a276d7..342a874bc 100644
--- a/cmake/dependencies.cmake
+++ b/cmake/dependencies.cmake
@@ -201,6 +201,9 @@ if(USE_HDF5)
 
   # Check to see if H5Dread_chunk is available
   check_symbol_exists(H5Dread_chunk "hdf5.h" HAS_READCHUNKS)
+  if(NOT HAS_READCHUNKS)
+    check_symbol_exists(H5Dread_chunk2 "hdf5.h" HAS_READCHUNKS)
+  endif()
 
   # Check to see if H5Pset_fapl_ros3 is available
   check_symbol_exists(H5Pset_fapl_ros3 "hdf5.h" HAS_HDF5_ROS3)
diff --git a/configure.ac b/configure.ac
index ddaca41d6..774ef899a 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1689,7 +1689,10 @@ if test "x$enable_hdf5" = xyes; then
    AC_MSG_RESULT([$hdf5_parallel])
 
    # See if H5Dread_chunk is available
-   AC_SEARCH_LIBS([H5Dread_chunk],[hdf5_hldll hdf5_hl], [has_readchunks=yes], [has_readdhunks=no])
+   AC_SEARCH_LIBS([H5Dread_chunk],[hdf5_hldll hdf5_hl], [has_readchunks=yes], [has_readchunks=no])
+   if test "x$has_readchunks" = xno; then
+    AC_SEARCH_LIBS([H5Dread_chunk2],[hdf5_hldll hdf5_hl], [has_readchunks=yes], [has_readchunks=no])
+   fi
 
    # See if hdf5 library supports Read-Only S3 (byte-range) driver
    AC_SEARCH_LIBS([H5Pset_fapl_ros3],[hdf5_hldll hdf5_hl], [has_hdf5_ros3=yes], [has_hdf5_ros3=no])
diff --git a/nc_test4/tst_alignment.c b/nc_test4/tst_alignment.c
index 385df0229..452a2ebc5 100644
--- a/nc_test4/tst_alignment.c
+++ b/nc_test4/tst_alignment.c
@@ -75,7 +75,12 @@ main(int argc, char **argv)
     memset(data,0,sizeof(data));
     hoffset[0] = 0;
 
+#if H5_VERSION_GE(2,0,0)
+    size_t data_size = sizeof(data);
+    if(H5Dread_chunk2(datasetid, dxpl_id, hoffset, &filter_mask, data, data_size) < 0) ERR;
+#else
     if(H5Dread_chunk(datasetid, dxpl_id, hoffset, &filter_mask, data) < 0) ERR;
+#endif
 
 #ifdef DEBUG
     fprintf(stderr,"H5Dread_chunk: offset=%lu   offset %% alignment=%lu\n",(unsigned long)hoffset[0], (((unsigned long)hoffset) % ALIGNMENT));
diff --git a/nczarr_test/ncdumpchunks.c b/nczarr_test/ncdumpchunks.c
index 758314aa2..a29a37c8f 100644
--- a/nczarr_test/ncdumpchunks.c
+++ b/nczarr_test/ncdumpchunks.c
@@ -411,9 +411,15 @@ dump(Format* format)
         switch (format->format) {
 #ifdef H5
 	case NC_FORMATX_NC_HDF5: {
-	    for(i=0;i<format->rank;i++) hoffset[i] = (hsize_t)offset[i];
+            for(i=0;i<format->rank;i++) hoffset[i] = (hsize_t)offset[i];
+#if H5_VERSION_GE(2,0,0)
+            size_t chunkdata_size = sizeof(chunkdata);
+            if(H5Dread_chunk2(datasetid, dxpl_id, hoffset, &filter_mask, chunkdata, chunkdata_size) < 0)
+                holechunk = 1;
+#else
 	    if(H5Dread_chunk(datasetid, dxpl_id, hoffset, &filter_mask, chunkdata) < 0)
-	        holechunk = 1;
+                holechunk = 1;
+#endif
 	} break;
 #endif
 #ifdef NZ
-- 
2.53.0

